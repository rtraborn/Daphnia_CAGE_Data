#Associates Tag Clusters (TSRs/promoter) to genes

#load libraries
library(GenomicRanges)
library(GenomicFeatures)

dpulex_genes <- read.table(file="/home/rtraborn/Daphnia/Daphnia_CAGE_Data/gene_annotations/dpulex_genes.bed", header=FALSE)
dpulex_promoters <- read.table(file="/home/rtraborn/Daphnia/Daphnia_CAGE_Data/promoter_arch/D_pulex/TCO/ConsensusClusters_TCO.bed",header=FALSE,sep="\t",stringsAsFactors=FALSE,skip=1)
dpulex_expression <- read.table(file="/home/rtraborn/Daphnia/Daphnia_CAGE_Data/promoter_arch/D_pulex/TCO/consensus_clusters_TCO.txt",stringsAsFactors=FALSE,header=TRUE)

names(dpulex_genes) <- c("chr","start","end","geneID","score","strand","version","type","placeholder","ID2")

names(dpulex_promoters) <- c("chr","start","end","placeholder","score","strand","start2","end2","score2")

#region around gene to call a TSS
span <- 400

#adding space to the genes on the positive strand
dpulex_genes[dpulex_genes$strand=='+','start']  <- dpulex_genes[dpulex_genes$strand=='+',"start"]-span
dpulex_genes[dpulex_genes$strand=='+','end']  <- dpulex_genes[dpulex_genes$strand=='+',"end"]+span

#adding space to the genes on the negative strand
dpulex_genes[dpulex_genes$strand=='-','start']  <- dpulex_genes[dpulex_genes$strand=='-',"start"]-span
dpulex_genes[dpulex_genes$strand=='-','end']  <- dpulex_genes[dpulex_genes$strand=='-',"end"]+span

#create GRanges object for all tag clusters
promoters_GR <- with(dpulex_promoters, GRanges(chr, IRanges(start,end,names=placeholder),strand))

genes_GR <- with(dpulex_genes, GRanges(chr, IRanges(start, end, names=geneID),strand))

#overlap TSRs with all tag clusters
tc_overlaps <- findOverlaps(promoters_GR, genes_GR)

#store number of overlaps
tc_overlaps_count <- countOverlaps(promoters_GR, genes_GR)

match_hit2 <- as.data.frame(tc_overlaps)

#name the columns
names(match_hit2) <- c('query','subject')

promoter_index <- match_hit2$query
gene_index <- match_hit2$subject

#gene_names <- dpulex_genes[gene_index,'geneID']

promoter_table <- data.frame(dpulex_promoters[promoter_index,1:3])
promoter_table$strand <- dpulex_promoters[promoter_index,6]

promoter_table$gene <- dpulex_genes[gene_index,4]

promoter_table$gene_start <- dpulex_genes[gene_index,'start']
promoter_table$gene_end <- dpulex_genes[gene_index,'end']
promoter_table$gene_strand <- dpulex_genes[gene_index,'strand']

promoter_table$expression <- dpulex_expression[promoter_index,6]

promoter_table$promoter <- paste(dpulex_genes[promoter_index,1], dpulex_genes[promoter_index,2], dpulex_genes[promoter_index,3], dpulex_genes[promoter_index,6],sep="_")

#names(combined.table2) <- c("chr","start","end","gene_ID","strand","start_TSR","end_TSR")

#remove duplicated entries
#match_hit2 <- match_hit2[!duplicated(match_hit2$query),]

write.table(promoter_table,file="TCO_combined_table.txt",col.names=TRUE, row.names=TRUE,quote=FALSE)

q()

